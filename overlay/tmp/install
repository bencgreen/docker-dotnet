#!/bin/sh

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# Add www user.
#======================================================================================================================

bf-adduser www


#======================================================================================================================
# Install dotnet dependencies.
#======================================================================================================================

apk add --no-cache \
    ca-certificates \
    icu-libs \
    krb5-libs \
    libgcc \
    libintl \
    libssl1.1 \
    libstdc++ \
    zlib


#======================================================================================================================
# Ensure target platform is set.
#======================================================================================================================

[[ -z "${TARGETPLATFORM-}" ]] && bf-error "Target platform not set."


#======================================================================================================================
# Get target platform architecture.
#======================================================================================================================

case "${TARGETPLATFORM}" in

    linux/amd64)
        ARCH="x64"
        ;;

    linux/arm64)
        ARCH="arm64"
        ;;

    *)
        bf-error "Unsupported target platform: ${TARGETPLATFORM}."
        ;;

esac

bf-echo "Platform architecture ${ARCH}."


#======================================================================================================================
# Get .NET Version.
#======================================================================================================================

cd /tmp

V=$(cat DOTNET_REVISION)
bf-echo ".NET version ${V}."


#======================================================================================================================
# Verify checksum of a dotnet download.
#   1   Either 'runtime' or 'aspnet'
#======================================================================================================================

verify () {

    DL="${ASPNET_VERSION}-${ARCH}-${1}"

    case "${DL}" in

        6-x64-runtime)      HASH="df9edbaa98011ef3d15ccc291a826c60e304908ac1495b7a61f1571718a9c8d8e94db3f88aacd37c6b94ac397115323def32fafd9cc16d41bfebb05491b0f7db" ;;
        6-arm64-runtime)    HASH="7c2e8c164cc8faffc7c3aacf9547bf825857b9d428063a1999f41bd579ea5579a06899fd4e0c13bb45514d2c5bcf849c7d999196f56c0cd6af5bf93f0de01117" ;;
        7-x64-runtime)      HASH="f853175cf9818d71f575762960319bf79d1a35bca7518de4594e8a9468ad8572328e2412eda091d989083b70001fc9b65d478314a58d67f0aa57a5da60e86fbd" ;;
        7-arm64-runtime)    HASH="77871fef3a4d7c03c12bacfc7d6dbc17586233a72d874a9f850184262d986dbd270521ebf254c1d96dfd5d275b2c96cc45f7ec28e1ec5116f90eca80550b85b2" ;;
        8-x64-runtime)      HASH="de70a6763a48ede2569e7816fafa269e02b72e5c761d561d2f3cb4affc3754c8d9934a77f6be7dd9e0e497fb702981536675db777c61872cadc0599465dc082a" ;;
        8-arm64-runtime)    HASH="3a80fda4fcb6215377cefc42d1b92442481939f40600101152173a465d2ac902f5cd689a9d48f5dfdf79bfbd00e05ae7eb94d82b3f252922c4dd34148df2295c" ;;

        6-x64-aspnet)       HASH="f20de3e9af088dc038e86445e32a226397b93c701e62a06e4e8e47e1392fc1dd80dbcc750870eacf87a42e1c54d764c8f01691a4666167c65922ab54e3b3414d" ;;
        6-arm64-aspnet)     HASH="cd44da7f6766cb2d07cef549270d0b010b106ec31553d7e5a9d0979cdc1be11045e03cf5d6bde584cfcd2da392392315c9c8f70bedc93c451483c413c118f1e2" ;;
        7-x64-aspnet)       HASH="77bcbc7230779d741f5a18199f18e4eda1b21d3034eb5ab37b20eeb40c4e15ee7556f2ffd4d512be05c3c063095e3e2e2c46d1f2758bd3f29082a6b40ce88f24" ;;
        7-arm64-aspnet)     HASH="3aba51e65739677db4e9e2735d78ba814022bc514d467e27c45775f9f6847c91804a798a9dffe550c3fccc4ce972266e0981a220f227414c9b45b79da0cc3c52" ;;
        8-x64-aspnet)       HASH="33abc6a11d3228a82d93ffe787cb13f374704368bd1c8ac74392246597c7395fd0b3ae90f1dccf5ed7629787a4cc2fdb67e8a44d7276a28f20634cbf460b68ab" ;;
        8-arm64-aspnet)     HASH="098f34fbcdd2c7d6f2b5a87c4b7bf826d6607583903a995277d707ac6dbae1c341bbbcb812753dc9f83c353f8834c0ea2590bf9b3aaf876a9cbc4c2ad90849a8" ;;

        *)                  bf-error "Unsupported dotnet download: ${DL}." ;;

    esac

    bf-echo "Verifying ${1} download..."
    echo "${HASH}  ${1}.tar.gz" | sha512sum -c -
    bf-done

}


#======================================================================================================================
# Download and install .NET Runtime.
#======================================================================================================================

DOTNET=/usr/share/dotnet

if [ "$(echo ${V} | cut -c 1)" == "8" ] ; then
    V="8.0.0-preview.4.23259.5"
    bf-echo "Changing version to ${V}."
fi

RUNTIME="runtime"
RUNTIME_URL="https://dotnetcli.azureedge.net/dotnet/Runtime/${V}/dotnet-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bf-echo "Downloading ${RUNTIME_URL}..."
wget -O ${RUNTIME}.tar.gz ${RUNTIME_URL}
bf-done

verify ${RUNTIME}

bf-echo "Installing .NET runtime..."
mkdir -p ${DOTNET} \
    && tar -C ${DOTNET} -oxzf ${RUNTIME}.tar.gz \
    && ln -s ${DOTNET}/dotnet /usr/bin/dotnet

[[ -d ${DOTNET} ]] && bf-done \
    || bf-error ".NET runtime not installed."


#======================================================================================================================
# Download and install ASP.NET Runtime.
#======================================================================================================================

if [ "$(echo ${V} | cut -c 1)" == "8" ] ; then
    V="8.0.0-preview.4.23260.4"
    bf-echo "Changing version to ${V}."
fi

ASPNET="aspnet"
ASPNET_URL="https://dotnetcli.azureedge.net/dotnet/aspnetcore/Runtime/${V}/aspnetcore-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bf-echo "Downloading ${ASPNET_URL}..."
wget -O ${ASPNET}.tar.gz ${ASPNET_URL}
bf-done

verify ${ASPNET}

bf-echo "Installing ASP.NET..."
tar -ozxf ${ASPNET}.tar.gz -C ${DOTNET} ./shared/Microsoft.AspNetCore.App

[[ -d ${DOTNET}/shared/Microsoft.AspNetCore.App/${V} ]] && bf-done \
    || bf-error "ASP.NET runtime not installed."
