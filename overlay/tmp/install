#!/bin/sh

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# Add www user.
#======================================================================================================================

bf-adduser www


#======================================================================================================================
# Install dotnet dependencies.
#======================================================================================================================

apk add --no-cache \
    ca-certificates \
    icu-libs \
    krb5-libs \
    libgcc \
    libintl \
    libssl1.1 \
    libstdc++ \
    zlib


#======================================================================================================================
# Ensure target platform is set.
#======================================================================================================================

[[ -z "${TARGETPLATFORM-}" ]] && bf-error "Target platform not set."


#======================================================================================================================
# Get target platform architecture.
#======================================================================================================================

case "${TARGETPLATFORM}" in

    linux/amd64)
        ARCH="x64"
        ;;

    linux/arm64)
        ARCH="arm64"
        ;;

    *)
        bf-error "Unsupported target platform: ${TARGETPLATFORM}."
        ;;

esac

bf-echo "Platform architecture ${ARCH}."


#======================================================================================================================
# Get .NET Version.
#======================================================================================================================

cd /tmp

V=$(cat DOTNET_REVISION)
bf-echo ".NET version ${V}."


#======================================================================================================================
# Verify checksum of a dotnet download.
#   1   Either 'runtime' or 'aspnet'
#======================================================================================================================

verify () {

    DL="${ASPNET_VERSION}-${ARCH}-${1}"

    case "${DL}" in

        6-x64-runtime)      HASH="18e2abd9d3e2d4ed1d78588976b31ec75c34c916f0680423889e7778ad80b91a3e92ff7185cc3d405db13e851276702ffc3a079d6d0705450515a27da63da483" ;;
        6-arm64-runtime)    HASH="1ca674dc6137821d5403fb856e842f39e1b04bcf38521a9e0ba34adecbe0a1d658826a8af5e8ef365c2fabed4e62a42b603b3f38472cc5208173e1162f79f289" ;;
        7-x64-runtime)      HASH="bdbde59fe535f450e34a323c42c5e7f404cd607969aa01a939895a23ec99778badbf653678f158232c3d9628c5278361a3e322b5662fc597917402227078da01" ;;
        7-arm64-runtime)    HASH="fdd897edddeaa3c3b11f9b8db449cba8157f14450bf2eefcad6cff7e71ecf13b6248aa343a680384b9708091deb9ab4722a78bd4aacdb6e219d2a9a40a4aec1a" ;;

        6-x64-aspnet)       HASH="6673574af4c5d45a3a78e64da3b2ad04fe15f4b68310711fe54dc5017f3ab82088ce731852164e6a8a266692d4cfac01540810344e00679289a868b7abc6f038" ;;
        6-arm64-aspnet)     HASH="c6c70694ad30215c3b1758a9e11846e3b26920d81fc0a7973972d1b085c7a131a40e3cdca3b92daeeeee5638915348091075f9f18fb18d8a0933f30985b9d2ad" ;;
        7-x64-aspnet)       HASH="cb51f4520770b2eaa33b2096e8ee5dce9f8ea6cf78355a6f02c63391a942a22e39438389da34a41393b88ffac848b9deb2f9f34a9c49971d99a6cb7551321e33" ;;
        7-arm64-aspnet)     HASH="8d5ad293426c0b9e4b8725b5fa22bbe6470a9e595a1dc34d2e1d7eec9c80cafad84692da6458c978fc78d0882abcbfb694dd63c523b44efb7db4ecbcf3f1f60d" ;;

        *)                  bf-error "Unsupported dotnet download: ${DL}." ;;

    esac

    bf-echo "Verifying ${1} download..."
    echo "${HASH}  ${1}.tar.gz" | sha512sum -c -
    bf-done

}


#======================================================================================================================
# Download and install .NET Runtime.
#======================================================================================================================

DOTNET=/usr/share/dotnet

# if [ "$(echo ${V} | cut -c 1)" == "7" ] ; then
#     V="7.0.0-rc.2.22472.3"
#     bf-echo "Changing version to ${V}."
# fi

RUNTIME="runtime"
RUNTIME_URL="https://dotnetcli.azureedge.net/dotnet/Runtime/${V}/dotnet-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bf-echo "Downloading ${RUNTIME_URL}..."
wget -O ${RUNTIME}.tar.gz ${RUNTIME_URL}
bf-done

verify ${RUNTIME}

bf-echo "Installing .NET runtime..."
mkdir -p ${DOTNET} \
    && tar -C ${DOTNET} -oxzf ${RUNTIME}.tar.gz \
    && ln -s ${DOTNET}/dotnet /usr/bin/dotnet

[[ -d ${DOTNET} ]] && bf-done \
    || bf-error ".NET runtime not installed."


#======================================================================================================================
# Download and install ASP.NET Runtime.
#======================================================================================================================

# if [ "$(echo ${V} | cut -c 1)" == "7" ] ; then
#     V="7.0.0-rc.2.22476.2"
#     bf-echo "Changing version to ${V}."
# fi

ASPNET="aspnet"
ASPNET_URL="https://dotnetcli.azureedge.net/dotnet/aspnetcore/Runtime/${V}/aspnetcore-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bf-echo "Downloading ${ASPNET_URL}..."
wget -O ${ASPNET}.tar.gz ${ASPNET_URL}
bf-done

verify ${ASPNET}

bf-echo "Installing ASP.NET..."
tar -ozxf ${ASPNET}.tar.gz -C ${DOTNET} ./shared/Microsoft.AspNetCore.App

[[ -d ${DOTNET}/shared/Microsoft.AspNetCore.App/${V} ]] && bf-done \
    || bf-error "ASP.NET runtime not installed."
