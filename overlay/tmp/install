#!/bin/sh

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# Add www user.
#======================================================================================================================

bf-adduser www


#======================================================================================================================
# Install dotnet dependencies.
#======================================================================================================================

apk add --no-cache \
    ca-certificates \
    icu-libs \
    krb5-libs \
    libgcc \
    libintl \
    libssl1.1 \
    libstdc++ \
    zlib


#======================================================================================================================
# Ensure target platform is set.
#======================================================================================================================

[[ -z "${TARGETPLATFORM-}" ]] && bf-error "Target platform not set."


#======================================================================================================================
# Get target platform architecture.
#======================================================================================================================

case "${TARGETPLATFORM}" in

    linux/amd64)
        ARCH="x64"
        ;;

    linux/arm64)
        ARCH="arm64"
        ;;

    *)
        bf-error "Unsupported target platform: ${TARGETPLATFORM}."
        ;;

esac

bf-echo "Platform architecture ${ARCH}."


#======================================================================================================================
# Get .NET Version.
#======================================================================================================================

cd /tmp

V=$(cat DOTNET_REVISION)
bf-echo ".NET version ${V}."


#======================================================================================================================
# Verify checksum of a dotnet download.
#   1   Either 'runtime' or 'aspnet'
#======================================================================================================================

verify () {

    DL="${ASPNET_VERSION}-${ARCH}-${1}"

    case "${DL}" in

        6-x64-runtime)      HASH="373e08d7bfc8cf990305f72dfbf3e7b5ab191809375d564d55f0cf1351ad51eb1a5d6bedd3090acb03054ab10cf0fad7b92f94452ba1fe02cd10fdd68646aba0" ;;
        6-arm64-runtime)    HASH="64e16eb79ceeabf3510689ff8390a10d487a89308aadc1c950f4b1cb6f8fcdc95c477508dadc342180d954aa317a09e71aab73d1abba3c5a91d15837ea56bb1e" ;;
        7-x64-runtime)      HASH="6b2a8a6c8a59feb2e349dd9e988dfd2ed25967e5b54230d393a509f1f6d919a8432791402deb853e25beaa6d5a89e6a179efb06c36ff90a7063f685b3d20f050" ;;
        7-arm64-runtime)    HASH="5f0b772d43abcac4529e0349478c79bec830880607d93d94529c20a3dd49646ab181e2c780976919a195d5e3b1806d4260ba72b2aa03d3afcca5ac595b46e88a" ;;
        8-x64-runtime)      HASH="4200335f7c2192cff85668bae6882c3f0296656730f532ebbbc218d1e52afa6d0d75f0369ee56cc91b5b5868f90a96b2004fc1c3a9fe0eacc07cff3974b5ea31" ;;
        8-arm64-runtime)    HASH="b17101bf0fcf75c526b7d15c9c181bddb6af23aa57153eb7d9f05b0d8ff7d3cefebf1041e7c92413d152e30c8345c907dc790f5325f2205a7c65a8cef494ffa1" ;;

        6-x64-aspnet)       HASH="fc615ee21591bffa97c5eec8c34aacbcd8a769d6e4b245578add58207f13bae30e70d93b89052493e228ab32eaf2fe529c04dde5a0bac6249ca709fd644009b0" ;;
        6-arm64-aspnet)     HASH="18532b56c42ea75039e4194ff0b12bdfecf8dd67443c50f22102e3bc5449b25dce15d1fe6fb330a8756d510fbdc257225c7e3ec86b93e6653442f19a0e4ebf46" ;;
        7-x64-aspnet)       HASH="37e9fdd91f1ee0c6627d5d0fd433fb64a51f576c1dbf29a92d1f209f36e2c8eb2fbead5213567f85013d7fe5c2874e9eac54b84dc2788b89972c2b92fd9898f0" ;;
        7-arm64-aspnet)     HASH="2947d01c38b9b23238a24c2b10174dc8793bb3c02fea34a9bb93811e865b189873c0a32936468d2a906639cc10d6d86ecf1929c0aac07081215b38a552876eb2" ;;
        8-x64-aspnet)       HASH="87b85205eeb2b803bdda931b347d1186411af4e94a26a30c914d332ee3769926d141b5c3f5987f3838b7b30031d523aa4d04b854a92cef36691d30a60b6250f5" ;;
        8-arm64-aspnet)     HASH="d773344c57a1fe7584b1f7e50ec8ef1441dafb25c47775fee51ebe51076d26ec4efb05c6b654d31a8e60e5817c806a7a4d2dd7988ba133d25f71b68a784d1e6a" ;;

        *)                  bf-error "Unsupported dotnet download: ${DL}." ;;

    esac

    bf-echo "Verifying ${1} download..."
    echo "${HASH}  ${1}.tar.gz" | sha512sum -c -
    bf-done

}


#======================================================================================================================
# Download and install .NET Runtime.
#======================================================================================================================

DOTNET=/usr/share/dotnet

if [ "$(echo ${V} | cut -c 1)" == "8" ] ; then
    bf-echo "Changing version to ${V}."
    V="8.0.0-preview.6.23329.7" # https://github.com/dotnet/dotnet-docker/blob/main/src/runtime/8.0/alpine3.18/arm64v8/Dockerfile
fi

RUNTIME="runtime"
RUNTIME_URL="https://dotnetcli.azureedge.net/dotnet/Runtime/${V}/dotnet-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bf-echo "Downloading ${RUNTIME_URL}..."
wget -O ${RUNTIME}.tar.gz ${RUNTIME_URL}
bf-done

verify ${RUNTIME}

bf-echo "Installing .NET runtime..."
mkdir -p ${DOTNET} \
    && tar -C ${DOTNET} -oxzf ${RUNTIME}.tar.gz \
    && ln -s ${DOTNET}/dotnet /usr/bin/dotnet

[[ -d ${DOTNET} ]] && bf-done \
    || bf-error ".NET runtime not installed."


#======================================================================================================================
# Download and install ASP.NET Runtime.
#======================================================================================================================

if [ "$(echo ${V} | cut -c 1)" == "8" ] ; then
    bf-echo "Changing version to ${V}."
    V="8.0.0-preview.6.23329.11" # https://github.com/dotnet/dotnet-docker/blob/main/src/aspnet/8.0/alpine3.18/arm64v8/Dockerfile
fi

ASPNET="aspnet"
ASPNET_URL="https://dotnetcli.azureedge.net/dotnet/aspnetcore/Runtime/${V}/aspnetcore-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bf-echo "Downloading ${ASPNET_URL}..."
wget -O ${ASPNET}.tar.gz ${ASPNET_URL}
bf-done

verify ${ASPNET}

bf-echo "Installing ASP.NET..."
tar -ozxf ${ASPNET}.tar.gz -C ${DOTNET} ./shared/Microsoft.AspNetCore.App

[[ -d ${DOTNET}/shared/Microsoft.AspNetCore.App/${V} ]] && bf-done \
    || bf-error "ASP.NET runtime not installed."
