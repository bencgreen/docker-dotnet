#!/bin/sh

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# Add www user.
#======================================================================================================================

bf-adduser www


#======================================================================================================================
# Install dotnet dependencies.
#======================================================================================================================

apk add --no-cache \
    ca-certificates \
    icu-libs \
    krb5-libs \
    libgcc \
    libintl \
    libssl1.1 \
    libstdc++ \
    zlib


#======================================================================================================================
# Ensure target platform is set.
#======================================================================================================================

[[ -z "${TARGETPLATFORM-}" ]] && bf-error "Target platform not set."


#======================================================================================================================
# Get target platform architecture.
#======================================================================================================================

case "${TARGETPLATFORM}" in

    linux/amd64)
        ARCH="x64"
        ;;

    linux/arm64)
        ARCH="arm64"
        ;;

    *)
        bf-error "Unsupported target platform: ${TARGETPLATFORM}."
        ;;

esac

bf-echo "Platform architecture ${ARCH}."


#======================================================================================================================
# Get .NET Version.
#======================================================================================================================

cd /tmp

V=$(cat DOTNET_REVISION)
bf-echo ".NET version ${V}."


#======================================================================================================================
# Verify checksum of a dotnet download.
#   1   Either 'runtime' or 'aspnet'
#======================================================================================================================

verify () {

    DL="${ASPNET_VERSION}-${ARCH}-${1}"

    case "${DL}" in

        6-x64-runtime)      HASH="89ed90be247136f205ae1f51ad932fc9ae04ff6b235a08564902f1327074704935850e573f550c404c5c53abde77fc51c222a2a5d94402d48ae379a42a004d88" ;;
        6-arm64-runtime)    HASH="72ff1a7faa5ba8af941456f830a8d09514fb63d9d30a352193480919c19dfaa60a19b7cbcb3d29ba0f6d8a3e3bc24450520509dcc043b769cc42c3562ad17255" ;;
        7-x64-runtime)      HASH="ad733f881301f471c9d5e8a882b3af3ef82914d422d824fb2acc85ecdac9a4278c6adae66864fc12dce8f0d51c02e3c22b56a519b3b25100a566a8d676c94a8d" ;;
        7-arm64-runtime)    HASH="7bdffd39fd163217eed64e13757b0746ef4073de371e74d6931b6d5e7ada42a576adfe61ef451ea316278ab05d746f136fdb2bdcdd2fdfb6e204045345d97548" ;;
        8-x64-runtime)      HASH="ef360a306780eabf0973589b12f2c38538b0723896d5860073f8ae31234fb718666d69acc1a7827074e90fd0a83165f135b097edb241a77964fe8856ef242847" ;;
        8-arm64-runtime)    HASH="bac16c501c8be61ce7fecbfd7b10165ce6fe5842b3858b255f8a5b0c7bc7ad74fd94eb930dd76d4d6b41c3af33b757dc097415e1da435f4f7a5050a0395007b5" ;;

        6-x64-aspnet)       HASH="1dace8bc0ec8ebd8634dbdaf7deffad93d7ef7bdd842e0ba66cfe8947857014c203d6811ad5acfd2cf6974d511c0d4b409d4e0aa909b1d7fc292a17662d0838a" ;;
        6-arm64-aspnet)     HASH="2bfc3f590399fbb97f22ecf35c2421c11e81102aa4a6c1fe660938be89af9ac3911ba679dd6d98366739703b31aca7e75f49f92b50e3e4b5caa482acb9fb1e66" ;;
        7-x64-aspnet)       HASH="9bef0fa7f492fd2d596db310a938953874bcc12210a963d8734d92820deb9b130cbfc78f86993b8f32d681d518724dd194a0e223719e4ecec9aa8b140ddfed5f" ;;
        7-arm64-aspnet)     HASH="dcedebd27948b37f727ac362e3241b96cfd1ac5ebf9bd7ca9e2cd8edf82d291e23850345c98b4ad6d4c0ffafd4081239a219da8c23aa847ef653e9da58be495b" ;;
        8-x64-aspnet)       HASH="46cf816b4207b6e5361e04962968629aa7c0f3245b017a55d4c0edbb1410705a458a250ea9d52f71e8d5d02b264c49e089c34c36f2cdb807e2667975a43f43e6" ;;
        8-arm64-aspnet)     HASH="5e351437fcf739666f446e4df639e3c78986e5d29465f2de8898a66b8825fbd2c378dd1ce8399d471fcb62c49f24738f0b96ef81cea004bf6912c2abdbe5a3f9" ;;

        *)                  bf-error "Unsupported dotnet download: ${DL}." ;;

    esac

    bf-echo "Verifying ${1} download..."
    echo "${HASH}  ${1}.tar.gz" | sha512sum -c -
    bf-done

}


#======================================================================================================================
# Download and install .NET Runtime.
#======================================================================================================================

DOTNET=/usr/share/dotnet

if [ "$(echo ${V} | cut -c 1)" == "8" ] ; then
    bf-echo "Changing version to ${V}."
    V="8.0.0-rc.1.23419.4" # https://github.com/dotnet/dotnet-docker/blob/main/src/runtime/8.0/alpine3.18/arm64v8/Dockerfile
fi

RUNTIME="runtime"
RUNTIME_URL="https://dotnetcli.azureedge.net/dotnet/Runtime/${V}/dotnet-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bf-echo "Downloading ${RUNTIME_URL}..."
wget -O ${RUNTIME}.tar.gz ${RUNTIME_URL}
bf-done

verify ${RUNTIME}

bf-echo "Installing .NET runtime..."
mkdir -p ${DOTNET} \
    && tar -C ${DOTNET} -oxzf ${RUNTIME}.tar.gz \
    && ln -s ${DOTNET}/dotnet /usr/bin/dotnet

[[ -d ${DOTNET} ]] && bf-done \
    || bf-error ".NET runtime not installed."


#======================================================================================================================
# Download and install ASP.NET Runtime.
#======================================================================================================================

if [ "$(echo ${V} | cut -c 1)" == "8" ] ; then
    bf-echo "Changing version to ${V}."
    V="8.0.0-rc.1.23421.29" # https://github.com/dotnet/dotnet-docker/blob/main/src/aspnet/8.0/alpine3.18/arm64v8/Dockerfile
fi

ASPNET="aspnet"
ASPNET_URL="https://dotnetcli.azureedge.net/dotnet/aspnetcore/Runtime/${V}/aspnetcore-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bf-echo "Downloading ${ASPNET_URL}..."
wget -O ${ASPNET}.tar.gz ${ASPNET_URL}
bf-done

verify ${ASPNET}

bf-echo "Installing ASP.NET..."
tar -ozxf ${ASPNET}.tar.gz -C ${DOTNET} ./shared/Microsoft.AspNetCore.App

[[ -d ${DOTNET}/shared/Microsoft.AspNetCore.App/${V} ]] && bf-done \
    || bf-error "ASP.NET runtime not installed."
