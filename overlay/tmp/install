#!/bin/sh

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# Add www user.
#======================================================================================================================

bf-adduser www


#======================================================================================================================
# Install dotnet dependencies.
#======================================================================================================================

apk add --no-cache \
    ca-certificates \
    krb5-libs \
    libgcc \
    libintl \
    libssl1.1 \
    libstdc++ \
    zlib


#======================================================================================================================
# Ensure target platform is set.
#======================================================================================================================

[[ -z "${TARGETPLATFORM-}" ]] && bf-error "Target platform not set."


#======================================================================================================================
# Get target platform architecture.
#======================================================================================================================

case "${TARGETPLATFORM}" in

    linux/amd64)
        ARCH="x64"
        ;;

    linux/arm64)
        ARCH="arm64"
        ;;

    *)
        bf-error "Unsupported target platform: ${TARGETPLATFORM}."
        ;;

esac

bf-debug "Platform architecture ${ARCH}."


#======================================================================================================================
# Get .NET Version.
#======================================================================================================================

cd /tmp

V=$(cat VERSION)
bf-debug ".NET version ${V}."


#======================================================================================================================
# Verify checksum of a dotnet download.
#   1   Either 'runtime' or 'aspnet'
#======================================================================================================================

verify () {

    DL="${ASPNET_VERSION_MINOR}-${ARCH}-${1}"

    case "${DL}" in

        3.1-x64-runtime)    HASH="6965afa8d5639edb293f44b8da3f42a0fec8a7c1673174da93963fab8a6bc3521a8e921e69b40a6b73c25ce25264a9be3b88205f2a7fa2c7a2ea8986f2227113" ;;
        3.1-arm64-runtime)  HASH="e1e25b6c1c89575b84183311b5b140dc28836e61779fb42d37a8d156437352e7be10b1a76529666ad8cab7ba353233b44f2a253b3e4579fb571cd06337488fe4" ;;
        5.0-x64-runtime)    HASH="86a149621e26a67ec72e8c7c11f8361d20a3a9043e5b66d8048317a43d8de834930fa4b6cf32804adbfb8a3c36875b8f69e0331a4133dc48ab3ac1c6409f2266" ;;
        5.0-arm64-runtime)  HASH="7e5345203679079c6875d0ede0198ab849a4b435afd58a6a13ed8f7e76a8be26d52c656f992bf928fbd541804a96757dc84738e8fc3fb036f3d0a1b2d503c501" ;;
        6.0-x64-runtime)    HASH="ee3fb0c0311e0d88ae3f8b0d150f8d98da4fa24d77c429438fad04393b24e214db49bfbc4c9e89918e99061004d63f40ec7b76cb1c0e1c2b12414be29ab63238" ;;
        6.0-arm64-runtime)  HASH="5a718a94e065d105f2e056672f8a0a7f3486626f253360ca0945dd468d9276e0c33c5a28b82dda9f3928b86967777af780bc2932d07ccea9b7a497dd9d90356c" ;;

        3.1-x64-aspnet)     HASH="e910816ccf840f2eed8546ed441acc968baff241522cf5c6456f38cd3344fc13eaf15d5a8daa5b4422ed63e79b8434b2a3413d7c660ecbdab437efdf88507b0c" ;;
        3.1-arm64-aspnet)   HASH="76c7c6c9b876b02209eff1807cf7bb482ae90bde2917980f13177d9f650aabc75fb7e36867d592863e594e61b61706cbffe54fed838fe482daff2233229bf5cc" ;;
        5.0-x64-aspnet)     HASH="0df3cd63230702520bc5678c4e7c7baed27a0525ead160d9bee509d7c42d0d2fa5cab79bf527727a6d9deb464953522e8b3d5de4a37b52ff9ac678dfdff2789a" ;;
        5.0-arm64-aspnet)   HASH="93e7db6f87eb7068726330567f277cc930ec3ff32d04b8ec3dd19167a58524d067dc78ef01614c0ba0d3421a2dd23bd497fdf01615f4a3884d5593298965eab2" ;;
        6.0-x64-aspnet)     HASH="bb85419cdc2cd6d5f357737230038d3ab685832a48964ef9e8a9f783e1ed6cba0f293ed47e187f05209f3d4c919d81de27c5add5c2424e15bc1b0600c92ed390" ;;
        6.0-arm64-aspnet)   HASH="8a301cc23db700d5188f29b1e63c3bde1631cf1bdc02d1070923532733d7a030be17dd4391d6d1f4596c11b1009aa38efbfa8335219bd1fac989158ba7e2a728" ;;

        *)                  bf-error "Unsupported dotnet download: ${DL}." ;;

    esac

    bf-echo "Verifying ${1} download..."
    echo "${HASH}  ${1}.tar.gz" | sha512sum -c -
    bf-done

}


#======================================================================================================================
# Download and install .NET Runtime.
#======================================================================================================================

DOTNET=/usr/share/dotnet

if [ "$(echo ${V} | cut -c 1)" == "6" ] ; then
    V="6.0.0-rc.2.21480.5"
    bf-debug "Changing version to ${V}."
fi

RUNTIME="runtime"
RUNTIME_URL="https://dotnetcli.azureedge.net/dotnet/Runtime/${V}/dotnet-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bf-echo "Downloading ${RUNTIME_URL}..."
wget -O ${RUNTIME}.tar.gz ${RUNTIME_URL}
bf-done

verify ${RUNTIME}

bf-echo "Installing .NET runtime..."
mkdir -p ${DOTNET} \
    && tar -C ${DOTNET} -oxzf ${RUNTIME}.tar.gz \
    && ln -s ${DOTNET}/dotnet /usr/bin/dotnet

[[ -d ${DOTNET} ]] && bf-done \
    || bf-error ".NET runtime not installed."


#======================================================================================================================
# Download and install ASP.NET Runtime.
#======================================================================================================================

if [ "$(echo ${V} | cut -c 1)" == "6" ] ; then
    V="6.0.0-rc.2.21480.10"
    bf-debug "Changing version to ${V}."
fi

ASPNET="aspnet"
ASPNET_URL="https://dotnetcli.azureedge.net/dotnet/aspnetcore/Runtime/${V}/aspnetcore-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bf-echo "Downloading ${ASPNET_URL}..."
wget -O ${ASPNET}.tar.gz ${ASPNET_URL}
bf-done

verify ${ASPNET}

bf-echo "Installing ASP.NET..."
tar -ozxf ${ASPNET}.tar.gz -C ${DOTNET} ./shared/Microsoft.AspNetCore.App

[[ -d ${DOTNET}/shared/Microsoft.AspNetCore.App/${V} ]] && bf-done \
    || bf-error "ASP.NET runtime not installed."


#======================================================================================================================
# Make app directories.
#======================================================================================================================

bf-debug "Creating /app directories."
mkdir -p /app/live
mkdir /app/publish
