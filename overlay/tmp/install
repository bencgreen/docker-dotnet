#!/bin/sh

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# Add www user.
#======================================================================================================================

bf-adduser www


#======================================================================================================================
# Install dotnet dependencies.
#======================================================================================================================

apk add --no-cache \
    ca-certificates \
    icu \
    krb5-libs \
    libgcc \
    libintl \
    libssl1.1 \
    libstdc++ \
    zlib


#======================================================================================================================
# Ensure target platform is set.
#======================================================================================================================

[[ -z "${TARGETPLATFORM-}" ]] && bf-error "Target platform not set."


#======================================================================================================================
# Get target platform architecture.
#======================================================================================================================

case "${TARGETPLATFORM}" in

    linux/amd64)
        ARCH="x64"
        ;;

    linux/arm64)
        ARCH="arm64"
        ;;

    *)
        bf-error "Unsupported target platform: ${TARGETPLATFORM}."
        ;;

esac

bf-echo "Platform architecture ${ARCH}."


#======================================================================================================================
# Get .NET Version.
#======================================================================================================================

cd /tmp

V=$(cat DOTNET_REVISION)
bf-echo ".NET version ${V}."


#======================================================================================================================
# Verify checksum of a dotnet download.
#   1   Either 'runtime' or 'aspnet'
#======================================================================================================================

verify () {

    DL="${ASPNET_VERSION_MINOR}-${ARCH}-${1}"

    case "${DL}" in

        3.1-x64-runtime)    HASH="ae4c397f2c0ddd9da99650f2cf22d3cb2cf13aa7feb25d79992b30f44ab49989d4d96d2671caeb962eaace58f2a1dfec2e5e5248b2ed35f1d1eb44343e12ba4c" ;;
        3.1-arm64-runtime)  HASH="3f80826bf922a17c6b08e92488335c65342abb8171a1eed017cdbf663e3c7fa005e115afbf0b1f9a6b4cffd7477f0dd53913cee63fdc04910e661b1b7691aec9" ;;
        5.0-x64-runtime)    HASH="e40ef40ebc7394cc7ef9eb9ce26b16a73bf99d597d98df009a06fff5d4fcec307e094ef6e780e8a2169351d9a93c92c18f20975fd1c6d75669218a29257fb6df" ;;
        5.0-arm64-runtime)  HASH="1c1495bf4a53a6d9b2be4c4b181946c3c5abd57ae6e10964924e3d650afba5e2986e555371b8134d0315a4054fc7d473ab4c8cc137f9e0569e8c67e46c4f559b" ;;
        6.0-x64-runtime)    HASH="de0224c5cb933ff557d19c4293a7a3591a54ae1b5d2de1f663195a1cab34c89986999fd63d43fe6d31fc5ad467d5f5cbd15636fa672c34303fc7eddb1708db7f" ;;
        6.0-arm64-runtime)  HASH="4b576997e7cf56f362db70d77ecca0b2dcf4f5435926eb0157242c99bac576112dde06b5aa396ba9b9d199d9d2427a10a273509f24685e5a2ac34dd5098a11e9" ;;
        7.0-x64-runtime)    HASH="8b550424c2de09cf5dfb161197d911d7e0a2e2323619de2d4c9031ad6d2a32793bb3d74054010fd4f815aefc9170328ebea04828f6818d066e9242ee64e9cdd2" ;;
        7.0-arm64-runtime)  HASH="a71b75af6c5f11e9eacecaafa57c8d0a6b597e3e0aa723dba617f7a95664711226fb0fd74c1349ed92a4b16651fc1c4113df066addb60618467533b33bb75916" ;;

        3.1-x64-aspnet)     HASH="1f8c12190a16fff5a8454262cd0e9bed7660ad63278c34d2935889ed043a56130a11dc2167c84277d4cdaee1a292a77b52114f411781a0bae74f72d663a9e05c" ;;
        3.1-arm64-aspnet)   HASH="aab5fbb9578354519737f495adbbf9ded777c4f20c21872912e60475515b30f62e130acb91d7c5dfa4575b37b393fc0f05cf8513844e4922ce7ff9acfd31ffe5" ;;
        5.0-x64-aspnet)     HASH="7df763553f6438c51f23542412830686fef82b56f1e3330fa2dfd86b894eff7d830b5ff51468cfe6e88d2eceebc0a0a2352c8762f65a0ffc6ca9f5b02863b7a6" ;;
        5.0-arm64-aspnet)   HASH="26f8a30e246c5527f03023e203e44dea1842e23ac587bc9872e6e60bd5ac98f57f7962d7d46c816690cb42263e9deedd896d0d3ad538a2d9dd17a06ba6f47fbb" ;;
        6.0-x64-aspnet)     HASH="b9f07997e5a930e096772a182fcb8f44826cf5fdaf4a5f8d5a9eba4f157373c694a50f57ee1b799fb0e6d4c4d8389cb45409d928e3fc5ea6f56303a190e1941a" ;;
        6.0-arm64-aspnet)   HASH="2f00c9960a7aeeb84cdb932de886c9843c7ec7c1cd4ffc82c5c5321f6da0239796bca8a5651f54a4c92b9c094d48e19244eb6c7f14489e53a522c8977d1c5658" ;;
        7.0-x64-aspnet)     HASH="0091895f2c80e7d9de0dd6fbbbf43f8529ea2d74fbbf4ad56fbc364f1444975e84b49830fe131ef922fb26e892fb4003b4fa0b0a709efd77133839235072909b" ;;
        7.0-arm64-aspnet)   HASH="f1bc9d47a27e21a23d5cf6c737a01a2ea6485bbff2d2e3c427643f51423e05bf08fc1605dabcded5bd2c01ba044ccea2083e2bb0e966a9e946dae4499a926c17" ;;

        *)                  bf-error "Unsupported dotnet download: ${DL}." ;;

    esac

    bf-echo "Verifying ${1} download..."
    echo "${HASH}  ${1}.tar.gz" | sha512sum -c -
    bf-done

}


#======================================================================================================================
# Download and install .NET Runtime.
#======================================================================================================================

DOTNET=/usr/share/dotnet

if [ "$(echo ${V} | cut -c 1)" == "7" ] ; then
    V="7.0.0-preview.4.22229.4"
    bf-echo "Changing version to ${V}."
fi

RUNTIME="runtime"
RUNTIME_URL="https://dotnetcli.azureedge.net/dotnet/Runtime/${V}/dotnet-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bf-echo "Downloading ${RUNTIME_URL}..."
wget -O ${RUNTIME}.tar.gz ${RUNTIME_URL}
bf-done

verify ${RUNTIME}

bf-echo "Installing .NET runtime..."
mkdir -p ${DOTNET} \
    && tar -C ${DOTNET} -oxzf ${RUNTIME}.tar.gz \
    && ln -s ${DOTNET}/dotnet /usr/bin/dotnet

[[ -d ${DOTNET} ]] && bf-done \
    || bf-error ".NET runtime not installed."


#======================================================================================================================
# Download and install ASP.NET Runtime.
#======================================================================================================================

if [ "$(echo ${V} | cut -c 1)" == "7" ] ; then
    V="7.0.0-preview.4.22251.1"
    bf-echo "Changing version to ${V}."
fi

ASPNET="aspnet"
ASPNET_URL="https://dotnetcli.azureedge.net/dotnet/aspnetcore/Runtime/${V}/aspnetcore-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bf-echo "Downloading ${ASPNET_URL}..."
wget -O ${ASPNET}.tar.gz ${ASPNET_URL}
bf-done

verify ${ASPNET}

bf-echo "Installing ASP.NET..."
tar -ozxf ${ASPNET}.tar.gz -C ${DOTNET} ./shared/Microsoft.AspNetCore.App

[[ -d ${DOTNET}/shared/Microsoft.AspNetCore.App/${V} ]] && bf-done \
    || bf-error "ASP.NET runtime not installed."


#======================================================================================================================
# Cleanup.
#======================================================================================================================

bf-echo "Removing .empty files..."
rm /app/live/.empty
rm /app/publish/.empty
bf-done
