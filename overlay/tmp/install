#!/bin/sh

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# Add www user.
#======================================================================================================================

bf-adduser www


#======================================================================================================================
# Install dotnet dependencies.
#======================================================================================================================

apk add --no-cache \
    ca-certificates \
    icu-libs \
    krb5-libs \
    libgcc \
    libintl \
    libssl1.1 \
    libstdc++ \
    zlib


#======================================================================================================================
# Ensure target platform is set.
#======================================================================================================================

[[ -z "${TARGETPLATFORM-}" ]] && bf-error "Target platform not set."


#======================================================================================================================
# Get target platform architecture.
#======================================================================================================================

case "${TARGETPLATFORM}" in

    linux/amd64)
        ARCH="x64"
        ;;

    linux/arm64)
        ARCH="arm64"
        ;;

    *)
        bf-error "Unsupported target platform: ${TARGETPLATFORM}."
        ;;

esac

bf-echo "Platform architecture ${ARCH}."


#======================================================================================================================
# Get .NET Version.
#======================================================================================================================

cd /tmp

V=$(cat DOTNET_REVISION)
bf-echo ".NET version ${V}."


#======================================================================================================================
# Verify checksum of a dotnet download.
#   1   Either 'runtime' or 'aspnet'
#======================================================================================================================

verify () {

    DL="${ASPNET_VERSION}-${ARCH}-${1}"

    case "${DL}" in

        6-x64-runtime)      HASH="126b22ce50bbdae2cbcfdd47dd6273451ff5e80fb3318d4fd1fa5cf9fd79aced6b9683f68fb02130a699808eb0c380ae0d8a400a04f24a286d21230d7df02423" ;;
        6-arm64-runtime)    HASH="61bf31dd2e13d9b4de7474b776eed6af8624fe30fce040638e677cfcdd3ae0650207a9805fed4f6542e908636a9d598235127e5b03e082ddc19294353ccb8735" ;;
        7-x64-runtime)      HASH="07cde581be0237eb9fef572ebe1e609b7b606781f45fcb0f7e13005197dbcce9c1d55e1ba0f1a3c155ea0e3de6062901f2816d70c31b0bc89999961e4079fe54" ;;
        7-arm64-runtime)    HASH="3aefbabbab78c2e46c62c48c76ffff8406362082969ebbf8e04bfb7547b066770c95312291284095e60aad8256527d09d293f612ab4049010dc4f5bdd95d165e" ;;

        6-x64-aspnet)       HASH="35fcfb6ba2048f1f942f667ffb333b0983347b8adf7b7d3db5152a222931f8b86fe5c62cb2fd45bf95a89e752056a946465ef546de295d32a911ac2c21acdbdd" ;;
        6-arm64-aspnet)     HASH="a4bcdf642bcc837c26d9d90a94e49318a579475f60284b89b824dff29f26d346d2da14ca6b5ad57df089b4b7174a4c9596b97dfae620a1a19f7afb23cedc0910" ;;
        7-x64-aspnet)       HASH="2e0ee65a2174c7c19d733d4d546dd7065f30d28f2e1f21de4ed7f0d35a4bd290d600275f77e1b378596ea202690c7f07fa389b177fbdc9c52c453e423ee915eb" ;;
        7-arm64-aspnet)     HASH="a8c1d190a62bc40dc398fabd166df6c0bffa2f15d95aab5652948910ae9a852911fe205f3b84d64bdb66e686f551fcd4e07b3805452a8294dea0f4aeae1b4696" ;;

        *)                  bf-error "Unsupported dotnet download: ${DL}." ;;

    esac

    bf-echo "Verifying ${1} download..."
    echo "${HASH}  ${1}.tar.gz" | sha512sum -c -
    bf-done

}


#======================================================================================================================
# Download and install .NET Runtime.
#======================================================================================================================

DOTNET=/usr/share/dotnet

# if [ "$(echo ${V} | cut -c 1)" == "7" ] ; then
#     V="7.0.0-rc.2.22472.3"
#     bf-echo "Changing version to ${V}."
# fi

RUNTIME="runtime"
RUNTIME_URL="https://dotnetcli.azureedge.net/dotnet/Runtime/${V}/dotnet-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bf-echo "Downloading ${RUNTIME_URL}..."
wget -O ${RUNTIME}.tar.gz ${RUNTIME_URL}
bf-done

verify ${RUNTIME}

bf-echo "Installing .NET runtime..."
mkdir -p ${DOTNET} \
    && tar -C ${DOTNET} -oxzf ${RUNTIME}.tar.gz \
    && ln -s ${DOTNET}/dotnet /usr/bin/dotnet

[[ -d ${DOTNET} ]] && bf-done \
    || bf-error ".NET runtime not installed."


#======================================================================================================================
# Download and install ASP.NET Runtime.
#======================================================================================================================

# if [ "$(echo ${V} | cut -c 1)" == "7" ] ; then
#     V="7.0.0-rc.2.22476.2"
#     bf-echo "Changing version to ${V}."
# fi

ASPNET="aspnet"
ASPNET_URL="https://dotnetcli.azureedge.net/dotnet/aspnetcore/Runtime/${V}/aspnetcore-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bf-echo "Downloading ${ASPNET_URL}..."
wget -O ${ASPNET}.tar.gz ${ASPNET_URL}
bf-done

verify ${ASPNET}

bf-echo "Installing ASP.NET..."
tar -ozxf ${ASPNET}.tar.gz -C ${DOTNET} ./shared/Microsoft.AspNetCore.App

[[ -d ${DOTNET}/shared/Microsoft.AspNetCore.App/${V} ]] && bf-done \
    || bf-error "ASP.NET runtime not installed."
