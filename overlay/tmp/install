#!/bin/sh

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# Add www user.
#======================================================================================================================

bf-adduser www


#======================================================================================================================
# Install dotnet dependencies.
#======================================================================================================================

apk add --no-cache \
    ca-certificates \
    icu-libs \
    krb5-libs \
    libgcc \
    libintl \
    libssl1.1 \
    libstdc++ \
    zlib


#======================================================================================================================
# Ensure target platform is set.
#======================================================================================================================

[[ -z "${TARGETPLATFORM-}" ]] && bf-error "Target platform not set."


#======================================================================================================================
# Get target platform architecture.
#======================================================================================================================

case "${TARGETPLATFORM}" in

    linux/amd64)
        ARCH="x64"
        ;;

    linux/arm64)
        ARCH="arm64"
        ;;

    *)
        bf-error "Unsupported target platform: ${TARGETPLATFORM}."
        ;;

esac

bf-echo "Platform architecture ${ARCH}."


#======================================================================================================================
# Get .NET Version.
#======================================================================================================================

cd /tmp

V=$(cat DOTNET_REVISION)
bf-echo ".NET version ${V}."


#======================================================================================================================
# Verify checksum of a dotnet download.
#   1   Either 'runtime' or 'aspnet'
#======================================================================================================================

verify () {

    DL="${ASPNET_VERSION}-${ARCH}-${1}"

    case "${DL}" in

        6-x64-runtime)      HASH="f5205bd0703a8c6db5dc4157849a734103bf2495ae10b15dce38cc03f12195b1a615367bc1f87a2ec4a05472753cd99858b8be2b74adfb93c3b558ebe1f045a1" ;;
        6-arm64-runtime)    HASH="827bd3b6117ed674ae290b2b80598551b91e67766533895fbd375b121e813f9d7927797fc91aafe3bf2cac927173703c7dbb4fd18dcc6a2648bf1f973dc86fec" ;;
        7-x64-runtime)      HASH="9d494a4748298c494609112d695439c114a42480f58d5b4cadd78a889ecb1b00ff10898cd7c3455589ac367d5a877bdc03621f74901355f063139778ae044c8b" ;;
        7-arm64-runtime)    HASH="660033371ee3a5ae06d64c366a1e1811c19da22eb8e23d67b5fd1c16dda2e52c9650d8c1c9bab6c289a76f89cc61ae97490c01de2f4e908de9e9b82777e97ef0" ;;
        8-x64-runtime)      HASH="c652094295b7df12d2d0272822cd861417c90c2313a87ebd515f3b0e9c67e165b133c4ef4b99f3731bf842a2145bf4607fa1c2db17fbea22615e2cb84d54db34" ;;
        8-arm64-runtime)    HASH="724c01d49d373b09c8213f06121ebd9169529b1f05fc3eb33fea3cc8619ad3bac6ff66d24feb253405fee9bbbffbbe7d1ff6c1bd4b5310564e3fb5cbd9617bfb" ;;

        6-x64-aspnet)       HASH="3beb72a24c2e2b91db929da38a3f0b975f8756f67a8302964321bcba93bdfb8bc407615b046a98b2daa8a755a3eaf6c8bab441a96814ccc22f8ff1753a7774e0" ;;
        6-arm64-aspnet)     HASH="ee720c88d3c77c9868a427e57a09ac57eb0c8529a281bb16cef6eddf574ef5084de9cc80df0f6c8371717c2df2392d11384fb0eb682909f3a5a1e2e6849b0ab9" ;;
        7-x64-aspnet)       HASH="9c4811ea4515f4c6650adc398272305861c76cf2a6e27f5966a4a8e1e042d6a2a7c2d36c71c51935768e7aca86e6536c92f2931f9c15af3526cfd6a15d6a0664" ;;
        7-arm64-aspnet)     HASH="52c87fcab1445b3afed26449cbe67244a7658c9b576d35f28d00763229dd8709699864cc9696dc0d9726e149a5a1ba1cc0485510decf51fd2cfc6afd4c6ff4e1" ;;
        8-x64-aspnet)       HASH="88e3326ba726562edeb2db997e0be3e66f00de59d372df8ded1d5a5cea57254fbaf4b4cadc091ff5cbe18eb23ecbdc86531b48e8fcd699ba226ac55624ee61cb" ;;
        8-arm64-aspnet)     HASH="e82cdf943268e56e739c094a0a4df685ec84790d8f10d3b261410ca434dc568f475879ffa57dc9765c1b2e3010578249c3a06eff9253556901fe364edf1c2a9b" ;;

        *)                  bf-error "Unsupported dotnet download: ${DL}." ;;

    esac

    bf-echo "Verifying ${1} download..."
    echo "${HASH}  ${1}.tar.gz" | sha512sum -c -
    bf-done

}


#======================================================================================================================
# Download and install .NET Runtime.
#======================================================================================================================

DOTNET=/usr/share/dotnet

if [ "$(echo ${V} | cut -c 1)" == "8" ] ; then
    bf-echo "Changing version to ${V}."
    V="8.0.0-preview.7.23375.6" # https://github.com/dotnet/dotnet-docker/blob/main/src/runtime/8.0/alpine3.18/arm64v8/Dockerfile
fi

RUNTIME="runtime"
RUNTIME_URL="https://dotnetcli.azureedge.net/dotnet/Runtime/${V}/dotnet-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bf-echo "Downloading ${RUNTIME_URL}..."
wget -O ${RUNTIME}.tar.gz ${RUNTIME_URL}
bf-done

verify ${RUNTIME}

bf-echo "Installing .NET runtime..."
mkdir -p ${DOTNET} \
    && tar -C ${DOTNET} -oxzf ${RUNTIME}.tar.gz \
    && ln -s ${DOTNET}/dotnet /usr/bin/dotnet

[[ -d ${DOTNET} ]] && bf-done \
    || bf-error ".NET runtime not installed."


#======================================================================================================================
# Download and install ASP.NET Runtime.
#======================================================================================================================

if [ "$(echo ${V} | cut -c 1)" == "8" ] ; then
    bf-echo "Changing version to ${V}."
    V="8.0.0-preview.7.23375.9" # https://github.com/dotnet/dotnet-docker/blob/main/src/aspnet/8.0/alpine3.18/arm64v8/Dockerfile
fi

ASPNET="aspnet"
ASPNET_URL="https://dotnetcli.azureedge.net/dotnet/aspnetcore/Runtime/${V}/aspnetcore-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bf-echo "Downloading ${ASPNET_URL}..."
wget -O ${ASPNET}.tar.gz ${ASPNET_URL}
bf-done

verify ${ASPNET}

bf-echo "Installing ASP.NET..."
tar -ozxf ${ASPNET}.tar.gz -C ${DOTNET} ./shared/Microsoft.AspNetCore.App

[[ -d ${DOTNET}/shared/Microsoft.AspNetCore.App/${V} ]] && bf-done \
    || bf-error "ASP.NET runtime not installed."
