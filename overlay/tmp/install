#!/bin/sh

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# Add www user.
#======================================================================================================================

bf-adduser www


#======================================================================================================================
# Install dotnet dependencies.
#======================================================================================================================

apk add --no-cache \
    ca-certificates \
    icu-libs \
    krb5-libs \
    libgcc \
    libintl \
    libssl1.1 \
    libstdc++ \
    zlib


#======================================================================================================================
# Ensure target platform is set.
#======================================================================================================================

[[ -z "${TARGETPLATFORM-}" ]] && bf-error "Target platform not set."


#======================================================================================================================
# Get target platform architecture.
#======================================================================================================================

case "${TARGETPLATFORM}" in

    linux/amd64)
        ARCH="x64"
        ;;

    linux/arm64)
        ARCH="arm64"
        ;;

    *)
        bf-error "Unsupported target platform: ${TARGETPLATFORM}."
        ;;

esac

bf-echo "Platform architecture ${ARCH}."


#======================================================================================================================
# Get .NET Version.
#======================================================================================================================

cd /tmp

V=$(cat DOTNET_REVISION)
bf-echo ".NET version ${V}."


#======================================================================================================================
# Verify checksum of a dotnet download.
#   1   Either 'runtime' or 'aspnet'
#======================================================================================================================

verify () {

    DL="${ASPNET_VERSION}-${ARCH}-${1}"

    case "${DL}" in

        6-x64-runtime)      HASH="3265ca274799e4de33fa0f60a9b88602c2245aa28da7891ec1343d1193d1f57f0c4b1cb5c561cc51bf73aaa92a4d5f382b8f63425fb32451b99837ccdb5d32b1" ;;
        6-arm64-runtime)    HASH="e37376a0c723fa9211ae904b34c1c35517dfc95b27078722c2b3b9e0aedd771551e3bcd1e1f502ae54a55843ed57236ba57c26110b537df7de77d391d9691bf8" ;;
        7-x64-runtime)      HASH="1cab2df1c4223b43d74cd40391c7bfbd0d226e170ee514d3c0aa4287a86c175a3cf6bb3e8a29b09cdd47c5258b3fd5ce0465d051b5b8ebf3e951c87c21ccda09" ;;
        7-arm64-runtime)    HASH="4395b004c8e91686d35c5c1edf0922e4c4162c1e0454d244c927a5200001d2f573a32f83c535e6c7975f1451109fb6402638c545ec0bb79aefc86089c9634005" ;;
        8-x64-runtime)      HASH="bd70483fb053519f5d001571595394b0da27cc53d6fa9bdfd1d9dfb1059495f44e82662c996b98e9c421ebab5a1334ccaed69cf88efe0177228aff7475466e3f" ;;
        8-arm64-runtime)    HASH="0f4a239d098a0ba9ba0089b0ea9dbefa188e59f0d377fb8d94cd75af1ac1a03063c49ac277bf1700ed07a0d59ad913a8863616b071f27d0e3afaab4603bab6b6" ;;

        6-x64-aspnet)       HASH="d19bdf6c9cbb1ff74866307c3c2914a025d918122c61cb2153562ef16c7ab2896d74ddaabb719d4e22675a8a0c3d8a67ffad71e8642297dd18f1c3bd345a54aa" ;;
        6-arm64-aspnet)     HASH="c8b91eedab034176d1dd5e9cf329f71ad42d2c96086fbf97a80d65e2d8154a8e15db339c9109d571e12460dfdc62f192a7249be0d7f17ef9c4df2b549ed785be" ;;
        7-x64-aspnet)       HASH="78c363b47316727e92fd4d4a4d60778fe4833a619f0b3caa49a7aa26e70532558792ded79620d9bb8be6dab37afd39fb097723b6e6a311f1cc5c765c1f878891" ;;
        7-arm64-aspnet)     HASH="2a1c5f92766d84fa0976de4434c7d828b0a98ca2c50e7cb672674dbc84f1626c855be1bb00d67e900d91485e6389317b478edd9f641f9350dc2726ab8fcb06d5" ;;
        8-x64-aspnet)       HASH="5e181bba7d2324a960f483c4474708232841a118baa3fd75a34245fc3d02fcca64a20211d0ca8db89dfe19f323106f6928fe7eaf0e691718b1f0f67a50eeab38" ;;
        8-arm64-aspnet)     HASH="5053934dc9ef63a321509b29f836f9e1277c8cfe63d6e7ed027ed5c393b11bb3b7912d044a3be8f299d0b642ff4aef81ad7be1be515a64e98c5c58025c020494" ;;

        *)                  bf-error "Unsupported dotnet download: ${DL}." ;;

    esac

    bf-echo "Verifying ${1} download..."
    echo "${HASH}  ${1}.tar.gz" | sha512sum -c -
    bf-done

}


#======================================================================================================================
# Download and install .NET Runtime.
#======================================================================================================================

DOTNET=/usr/share/dotnet

if [ "$(echo ${V} | cut -c 1)" == "8" ] ; then
    V="8.0.0-preview.5.23280.8"
    bf-echo "Changing version to ${V}."
fi

RUNTIME="runtime"
RUNTIME_URL="https://dotnetcli.azureedge.net/dotnet/Runtime/${V}/dotnet-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bf-echo "Downloading ${RUNTIME_URL}..."
wget -O ${RUNTIME}.tar.gz ${RUNTIME_URL}
bf-done

verify ${RUNTIME}

bf-echo "Installing .NET runtime..."
mkdir -p ${DOTNET} \
    && tar -C ${DOTNET} -oxzf ${RUNTIME}.tar.gz \
    && ln -s ${DOTNET}/dotnet /usr/bin/dotnet

[[ -d ${DOTNET} ]] && bf-done \
    || bf-error ".NET runtime not installed."


#======================================================================================================================
# Download and install ASP.NET Runtime.
#======================================================================================================================

if [ "$(echo ${V} | cut -c 1)" == "8" ] ; then
    V="8.0.0-preview.5.23302.2"
    bf-echo "Changing version to ${V}."
fi

ASPNET="aspnet"
ASPNET_URL="https://dotnetcli.azureedge.net/dotnet/aspnetcore/Runtime/${V}/aspnetcore-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bf-echo "Downloading ${ASPNET_URL}..."
wget -O ${ASPNET}.tar.gz ${ASPNET_URL}
bf-done

verify ${ASPNET}

bf-echo "Installing ASP.NET..."
tar -ozxf ${ASPNET}.tar.gz -C ${DOTNET} ./shared/Microsoft.AspNetCore.App

[[ -d ${DOTNET}/shared/Microsoft.AspNetCore.App/${V} ]] && bf-done \
    || bf-error "ASP.NET runtime not installed."
