#!/bin/sh

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# Add www user.
#======================================================================================================================

bf-adduser www


#======================================================================================================================
# Install dotnet dependencies.
#======================================================================================================================

apk add --no-cache \
    ca-certificates \
    icu \
    krb5-libs \
    libgcc \
    libintl \
    libssl1.1 \
    libstdc++ \
    zlib


#======================================================================================================================
# Ensure target platform is set.
#======================================================================================================================

[[ -z "${TARGETPLATFORM-}" ]] && bf-error "Target platform not set."


#======================================================================================================================
# Get target platform architecture.
#======================================================================================================================

case "${TARGETPLATFORM}" in

    linux/amd64)
        ARCH="x64"
        ;;

    linux/arm64)
        ARCH="arm64"
        ;;

    *)
        bf-error "Unsupported target platform: ${TARGETPLATFORM}."
        ;;

esac

bf-echo "Platform architecture ${ARCH}."


#======================================================================================================================
# Get .NET Version.
#======================================================================================================================

cd /tmp

V=$(cat DOTNET_REVISION)
bf-echo ".NET version ${V}."


#======================================================================================================================
# Verify checksum of a dotnet download.
#   1   Either 'runtime' or 'aspnet'
#======================================================================================================================

verify () {

    DL="${ASPNET_VERSION_MINOR}-${ARCH}-${1}"

    case "${DL}" in

        3.1-x64-runtime)    HASH="fb5328fb29e71c5f35c5c5e08a57db6d27b9fe66ee2a01f72ecc7fa097da1d9e1939c20a75ac0fad4937a19eed28f299a99d1c94fcbbe040f55ac53ee3eea00a" ;;
        3.1-arm64-runtime)  HASH="ee679a99a89a0f4a843595fc0fd3cb72883612e8bbe2a38edc6803014c6999bd4aac208ecee77899a19aefa347379888c2a9676c1b7e0689019eedf139f0e51e" ;;
        5.0-x64-runtime)    HASH="49310a377cb112375519477fe9a668fd45dabf560ed55659b56e557afc3e33e030ec683bc046314d86424f699c0987c55630a5155874351feffa91deefdf53f2" ;;
        5.0-arm64-runtime)  HASH="6c7b5d83c6f443254a343d04fbd18a1197efece15c9b306fd26a4830ddfe16f8ba24e54e695ab1af25024b77668ed078884c0e5c7e4e579f0706d74146312a02" ;;
        6.0-x64-runtime)    HASH="e5b538482f10a667bee3b7482db0ac0cac27b5bddab9f3ab68bd5c5d7c18c5bec2bdcb8cd288052c3f3e186291ee02190ff01896c2835ce32b87e18cd817759e" ;;
        6.0-arm64-runtime)  HASH="65d79da43cbda980a72d6cc4131059dc36f322d1c8ce8e8e6c1729486b5eec7569d4f416045d8a3fa647f8ff684f9ee5ba84ce898cd227e2b615d635b61da8cb" ;;
        7.0-x64-runtime)    HASH="0020af8b0aa18099d3f7ea1ea9d989bbf51f66fe269625701681cb57e46f6e0c2aa61388606b8150e521142f516df50f4ee4f15dc9c73237007fa4e77552b96e" ;;
        7.0-arm64-runtime)  HASH="4e064f48b52580f0e870281c9119d5f655d133ca8ae64bf3a0f06ccc644fb8cd531236f49ee5ae8e1316660c9df253a686412c86ede9d386c838cf6131b87d23" ;;

        3.1-x64-aspnet)     HASH="1341b6e0a9903b253a69fdf1a60cd9e6be8a5c7ea3c4a52cd1a8159461f6ba37bef7c2ae0d6df5e1ebd38cd373cf384dc55c6ef876aace75def0ac77427d3bb0" ;;
        3.1-arm64-aspnet)   HASH="242cf82d00cac6493627b07a7ffa45e1a62881146793b2b5db977f9755cad218b764ef540bf5dcc3f5d3241b7eb48255eda10227d372832fa97603295519edd3" ;;
        5.0-x64-aspnet)     HASH="d7aa3a3753505448cc3ba38bc17bf767503e328fade8e8bbc6ac5da8e12ec29737159ec75d327ee71e7f628282a272df0fb4b20e296edbb5f282d2db859a1457" ;;
        5.0-arm64-aspnet)   HASH="72a82d95dfd5210653253c5d3d8ba4eedf67530f11d0680b547f31d77bde0d13a957a5af59ca71e86f70960facc7119a270ca55c050cf985e7e56b6b331d1490" ;;
        6.0-x64-aspnet)     HASH="f54624306b74d9be0a670c2b1d465991b2c1ef67a4c216532fba9dc85f525a68d9ba6e1405945905dc834e073e676f0234d18edc5c9507d5b6c420bb2d073a40" ;;
        6.0-arm64-aspnet)   HASH="f7c69af61947c6d5a6f5f91a1e3ec3cdcb20d37d0839ef47d6cdf5da13d8109479084363b826585395599d636f5df34f56f5f5751f7ee166a63790104f256ec7" ;;
        7.0-x64-aspnet)     HASH="4d7e8c4d92c1c742eadfd9f830e9a3af00a5dc5e9becc2aff3364b86ce2770042899135ee08e593c907521ff3dfe860b37eceff3a6c3a753ed79358672fa9a8a" ;;
        7.0-arm64-aspnet)   HASH="ac98b8025125dc23545544c2ea91a887c049cb334e5855c47c4cc76c7ca5438b895124dc20ec80df7414e4d9987105d0e3815365b85a3ea0ea108e66ad3fa458" ;;

        *)                  bf-error "Unsupported dotnet download: ${DL}." ;;

    esac

    bf-echo "Verifying ${1} download..."
    echo "${HASH}  ${1}.tar.gz" | sha512sum -c -
    bf-done

}


#======================================================================================================================
# Download and install .NET Runtime.
#======================================================================================================================

DOTNET=/usr/share/dotnet

if [ "$(echo ${V} | cut -c 1)" == "7" ] ; then
    V="7.0.0-preview.2.22152.2"
    bf-echo "Changing version to ${V}."
fi

RUNTIME="runtime"
RUNTIME_URL="https://dotnetcli.azureedge.net/dotnet/Runtime/${V}/dotnet-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bf-echo "Downloading ${RUNTIME_URL}..."
wget -O ${RUNTIME}.tar.gz ${RUNTIME_URL}
bf-done

verify ${RUNTIME}

bf-echo "Installing .NET runtime..."
mkdir -p ${DOTNET} \
    && tar -C ${DOTNET} -oxzf ${RUNTIME}.tar.gz \
    && ln -s ${DOTNET}/dotnet /usr/bin/dotnet

[[ -d ${DOTNET} ]] && bf-done \
    || bf-error ".NET runtime not installed."


#======================================================================================================================
# Download and install ASP.NET Runtime.
#======================================================================================================================

if [ "$(echo ${V} | cut -c 1)" == "7" ] ; then
    V="7.0.0-preview.2.22153.2"
    bf-echo "Changing version to ${V}."
fi

ASPNET="aspnet"
ASPNET_URL="https://dotnetcli.azureedge.net/dotnet/aspnetcore/Runtime/${V}/aspnetcore-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bf-echo "Downloading ${ASPNET_URL}..."
wget -O ${ASPNET}.tar.gz ${ASPNET_URL}
bf-done

verify ${ASPNET}

bf-echo "Installing ASP.NET..."
tar -ozxf ${ASPNET}.tar.gz -C ${DOTNET} ./shared/Microsoft.AspNetCore.App

[[ -d ${DOTNET}/shared/Microsoft.AspNetCore.App/${V} ]] && bf-done \
    || bf-error "ASP.NET runtime not installed."


#======================================================================================================================
# Cleanup.
#======================================================================================================================

bf-echo "Removing .empty files..."
rm /app/live/.empty
rm /app/publish/.empty
bf-done
