#!/bin/sh

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# Add www user.
#======================================================================================================================

bf-adduser www


#======================================================================================================================
# Install dotnet dependencies.
#======================================================================================================================

apk add --no-cache \
    ca-certificates \
    icu \
    krb5-libs \
    libgcc \
    libintl \
    libssl1.1 \
    libstdc++ \
    zlib


#======================================================================================================================
# Ensure target platform is set.
#======================================================================================================================

[[ -z "${TARGETPLATFORM-}" ]] && bf-error "Target platform not set."


#======================================================================================================================
# Get target platform architecture.
#======================================================================================================================

case "${TARGETPLATFORM}" in

    linux/amd64)
        ARCH="x64"
        ;;

    linux/arm64)
        ARCH="arm64"
        ;;

    *)
        bf-error "Unsupported target platform: ${TARGETPLATFORM}."
        ;;

esac

bf-echo "Platform architecture ${ARCH}."


#======================================================================================================================
# Get .NET Version.
#======================================================================================================================

cd /tmp

V=$(cat DOTNET_REVISION)
bf-echo ".NET version ${V}."


#======================================================================================================================
# Verify checksum of a dotnet download.
#   1   Either 'runtime' or 'aspnet'
#======================================================================================================================

verify () {

    DL="${ASPNET_VERSION_MINOR}-${ARCH}-${1}"

    case "${DL}" in

        3.1-x64-runtime)    HASH="20fed726e85ff1aed1f53afb4a193fdac83275636f8a9370b0de8498689e0f82919c45df5aa128e68f5323d2cedc8b4ecafff192ac8765f2e2cdacd6ecb8a920" ;;
        3.1-arm64-runtime)  HASH="a5ddf7254d620437703215ff3a4292a31585f7349a85db87b2ee855726d1e55828715d38806439ba01ae4221ff562bd3c46e65cceef4b80999ee836d966539ef" ;;
        6.0-x64-runtime)    HASH="dc8374ff31d4ae29094815a8df48c777614153820a0ed47454c882fed596aa485010eeb852543e3974bb8d3b37df143bf1c6a3a22305835907c350c2d40017cb" ;;
        6.0-arm64-runtime)  HASH="815dbe96eb4ec34c7cfc2856d6e3a98b8d8bbc13aa698c96e6ff69bf8f403df589c6dc54d465fae5692dd0ac198f66898f846ffdf6b22dcbc9566fbf99430f3b" ;;
        7.0-x64-runtime)    HASH="fccd4c764f1e0c5595591909cbd45e6ef06007a33b89453a6fbd7fbb86d33f5e96b49ec66a4e4b2d8e1093ed5eb852fe3d8fa47be5773094ed417ee484d7ca39" ;;
        7.0-arm64-runtime)  HASH="a5be4e53fee0bcd5940c1a21d78e9973e9e9ccff13da3f857dda3b0506aec52217cbcd05da3d4906924d8a003445172fd2f317ba7df393ac80d42c40262e0790" ;;

        3.1-x64-aspnet)     HASH="5d73545eab4293d64e8904b9205bc63b1f9c702f391b038209e55ab5d83d1e44517c12a9e0b8dbc7d445a4703a0780ca0f85b077db5a006cda9208441d24f6fc" ;;
        3.1-arm64-aspnet)   HASH="fac06b2bf77f9f74c1d42528f63e09d0805a2f1a654dc7b89bbbb0e467f0efa28a8830097c7c2135ff6c6853261c8c21e28c1c7a9995446fda4763b62f72cd35" ;;
        6.0-x64-aspnet)     HASH="676864175e8ac286b83ce231a5a218050998e8f0903521c7667e1e8b58b035dba45f90c8894e164f70480fc55e32a623b0fad229f28f59d692c53ca97b695092" ;;
        6.0-arm64-aspnet)   HASH="efac4d9f91a8f442f6223f77e09eafd4fec4d2daac395f968549ebba37285804c77617919c9cd3b900805e3a876d4d8aae2ade31140a6f278598aca4fd0c5995" ;;
        7.0-x64-aspnet)     HASH="8ef7f83b4eaa679ff375c5075472c093a9a70d2453927d37c8baab36eecb8feb26eac0765f63e4bd4bfcc7181248531f164c03072642f63ed86ccb895a2f3908" ;;
        7.0-arm64-aspnet)   HASH="78593bcb6726143d07713fa7ba16e7058dcf1a381c65fc4479cc016400d25062677c03f753cb3aba8d5cda4e818f11ffbc79e7f3e92acb031891c75c1c20fdbf" ;;

        *)                  bf-error "Unsupported dotnet download: ${DL}." ;;

    esac

    bf-echo "Verifying ${1} download..."
    echo "${HASH}  ${1}.tar.gz" | sha512sum -c -
    bf-done

}


#======================================================================================================================
# Download and install .NET Runtime.
#======================================================================================================================

DOTNET=/usr/share/dotnet

if [ "$(echo ${V} | cut -c 1)" == "7" ] ; then
    V="7.0.0-preview.5.22301.12"
    bf-echo "Changing version to ${V}."
fi

RUNTIME="runtime"
RUNTIME_URL="https://dotnetcli.azureedge.net/dotnet/Runtime/${V}/dotnet-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bf-echo "Downloading ${RUNTIME_URL}..."
wget -O ${RUNTIME}.tar.gz ${RUNTIME_URL}
bf-done

verify ${RUNTIME}

bf-echo "Installing .NET runtime..."
mkdir -p ${DOTNET} \
    && tar -C ${DOTNET} -oxzf ${RUNTIME}.tar.gz \
    && ln -s ${DOTNET}/dotnet /usr/bin/dotnet

[[ -d ${DOTNET} ]] && bf-done \
    || bf-error ".NET runtime not installed."


#======================================================================================================================
# Download and install ASP.NET Runtime.
#======================================================================================================================

if [ "$(echo ${V} | cut -c 1)" == "7" ] ; then
    V="7.0.0-preview.5.22303.8"
    bf-echo "Changing version to ${V}."
fi

ASPNET="aspnet"
ASPNET_URL="https://dotnetcli.azureedge.net/dotnet/aspnetcore/Runtime/${V}/aspnetcore-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bf-echo "Downloading ${ASPNET_URL}..."
wget -O ${ASPNET}.tar.gz ${ASPNET_URL}
bf-done

verify ${ASPNET}

bf-echo "Installing ASP.NET..."
tar -ozxf ${ASPNET}.tar.gz -C ${DOTNET} ./shared/Microsoft.AspNetCore.App

[[ -d ${DOTNET}/shared/Microsoft.AspNetCore.App/${V} ]] && bf-done \
    || bf-error "ASP.NET runtime not installed."


#======================================================================================================================
# Cleanup.
#======================================================================================================================

bf-echo "Removing .empty files..."
rm /app/live/.empty
rm /app/publish/.empty
bf-done
