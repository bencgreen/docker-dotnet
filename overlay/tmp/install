#!/bin/sh

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# Add www user.
#======================================================================================================================

bf-adduser www


#======================================================================================================================
# Install dotnet dependencies.
#======================================================================================================================

apk add --no-cache \
    ca-certificates \
    icu \
    krb5-libs \
    libgcc \
    libintl \
    libssl1.1 \
    libstdc++ \
    zlib


#======================================================================================================================
# Ensure target platform is set.
#======================================================================================================================

[[ -z "${TARGETPLATFORM-}" ]] && bf-error "Target platform not set."


#======================================================================================================================
# Get target platform architecture.
#======================================================================================================================

case "${TARGETPLATFORM}" in

    linux/amd64)
        ARCH="x64"
        ;;

    linux/arm64)
        ARCH="arm64"
        ;;

    *)
        bf-error "Unsupported target platform: ${TARGETPLATFORM}."
        ;;

esac

bf-echo "Platform architecture ${ARCH}."


#======================================================================================================================
# Get .NET Version.
#======================================================================================================================

cd /tmp

V=$(cat DOTNET_REVISION)
bf-echo ".NET version ${V}."


#======================================================================================================================
# Verify checksum of a dotnet download.
#   1   Either 'runtime' or 'aspnet'
#======================================================================================================================

verify () {

    DL="${ASPNET_VERSION_MINOR}-${ARCH}-${1}"

    case "${DL}" in

        3.1-x64-runtime)    HASH="d81ffebcb8eda65bb3a1f60832d0f4f6eae746bfa3734a94915485f8e77af7bc0d33660173008cd3d8c6d527ae9f8d6b4dd64cde50b7576787c7ad25e5073419" ;;
        3.1-arm64-runtime)  HASH="f39dfbd0a71a608e044bc44943e7ddff539eee7a8fb9541c8b81bf8123158bb7ac0ad76bd1e858a7646803dbe754b5a3998caf32dd7a5710f7371c82abd7b288" ;;
        6.0-x64-runtime)    HASH="8bc10a7a6e08783ce89d047477828a001b7b12a959cd3c46d1013d2ab8dc65cda35b466924006f63b317e0d7301641097fc3fdf262c5e72990376ab34956ea92" ;;
        6.0-arm64-runtime)  HASH="d1d74cefec7075ba9a1fb88cc53afa677c88275b1ad431df4fda78c7e239a42e1fc14f3c7dce50d8f5505419540062dda21537363d9797ae71317b6206a4e906" ;;
        7.0-x64-runtime)    HASH="f37774eee98f38d9849c79d05c58b0d9e733d480b31a0615a1039613662579efef392d0129b2582281861c0647bacdb3acd78213bd33869b698e529b8e78ccee" ;;
        7.0-arm64-runtime)  HASH="8e51878ff716d56366c52af7ff92375d3df796ceb56a74ff88fce6c3461003ed05be1ed6504c0d7d217afdce1097895c8df508d4c64d7fae537ff53482c3f8ca" ;;

        3.1-x64-aspnet)     HASH="f3e28547974303257a76af87fec7d0084c8efce4359ecf761ecab191336679f2ffe12928f7edb6624442ad7b0a38738c9a3fe2fd5d7fece1fa16441e4898de32" ;;
        3.1-arm64-aspnet)   HASH="ce61ffe110dc5dbac31f1abdf040d06d1fae2bf52065f6a88f77785d879f4f916e3335cd9c75cf4cb4e6c8a0208089e663f81972c4b4bd84a8589e73aed03450" ;;
        6.0-x64-aspnet)     HASH="6415d01659656435767833f2f19d1f969940710bfbad3ffddf8bcce8b7130b1d5761fa4f0b3167177c8bc91d7fcb4bda6a7ab0014b80a27638f62ced48febb2f" ;;
        6.0-arm64-aspnet)   HASH="b068d87b9b848971f2b18dba841c651d59330e72e3b8259a657d67606dd03808482d80393a8da82c452dcdf90c8d7a5213764d420ac956c94cf69f2d5825ae30" ;;
        7.0-x64-aspnet)     HASH="099cd5b3078f50036e5a638a83aaef987fa1a01f593986cca97ee35c8cb4e2707bf49559ae1bc55cf063d5f8ac2d9a1ec1b64371e075550faf47febeadc9bb47" ;;
        7.0-arm64-aspnet)   HASH="8f6a881a061a6b5459039b57d1d8b9363828bdd4b98c16a214202b7e0a9841f07ed45cbd13d9ed588ba4ff5c072af4748f9728e64b6ff88559b72e395986e674" ;;

        *)                  bf-error "Unsupported dotnet download: ${DL}." ;;

    esac

    bf-echo "Verifying ${1} download..."
    echo "${HASH}  ${1}.tar.gz" | sha512sum -c -
    bf-done

}


#======================================================================================================================
# Download and install .NET Runtime.
#======================================================================================================================

DOTNET=/usr/share/dotnet

# if [ "$(echo ${V} | cut -c 1)" == "7" ] ; then
#     V="7.0.0-rc.2.22472.3"
#     bf-echo "Changing version to ${V}."
# fi

RUNTIME="runtime"
RUNTIME_URL="https://dotnetcli.azureedge.net/dotnet/Runtime/${V}/dotnet-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bf-echo "Downloading ${RUNTIME_URL}..."
wget -O ${RUNTIME}.tar.gz ${RUNTIME_URL}
bf-done

verify ${RUNTIME}

bf-echo "Installing .NET runtime..."
mkdir -p ${DOTNET} \
    && tar -C ${DOTNET} -oxzf ${RUNTIME}.tar.gz \
    && ln -s ${DOTNET}/dotnet /usr/bin/dotnet

[[ -d ${DOTNET} ]] && bf-done \
    || bf-error ".NET runtime not installed."


#======================================================================================================================
# Download and install ASP.NET Runtime.
#======================================================================================================================

# if [ "$(echo ${V} | cut -c 1)" == "7" ] ; then
#     V="7.0.0-rc.2.22476.2"
#     bf-echo "Changing version to ${V}."
# fi

ASPNET="aspnet"
ASPNET_URL="https://dotnetcli.azureedge.net/dotnet/aspnetcore/Runtime/${V}/aspnetcore-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bf-echo "Downloading ${ASPNET_URL}..."
wget -O ${ASPNET}.tar.gz ${ASPNET_URL}
bf-done

verify ${ASPNET}

bf-echo "Installing ASP.NET..."
tar -ozxf ${ASPNET}.tar.gz -C ${DOTNET} ./shared/Microsoft.AspNetCore.App

[[ -d ${DOTNET}/shared/Microsoft.AspNetCore.App/${V} ]] && bf-done \
    || bf-error "ASP.NET runtime not installed."
