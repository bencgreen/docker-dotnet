#!/bin/sh

set -euo pipefail
export BF_E=`basename ${0}`


#======================================================================================================================
# Add www user.
#======================================================================================================================

bf-adduser www


#======================================================================================================================
# Install dotnet dependencies.
#======================================================================================================================

apk add --no-cache \
    ca-certificates \
    icu-libs \
    krb5-libs \
    libgcc \
    libintl \
    libssl1.1 \
    libstdc++ \
    zlib


#======================================================================================================================
# Ensure target platform is set.
#======================================================================================================================

[[ -z "${TARGETPLATFORM-}" ]] && bf-error "Target platform not set."


#======================================================================================================================
# Get target platform architecture.
#======================================================================================================================

case "${TARGETPLATFORM}" in

    linux/amd64)
        ARCH="x64"
        ;;

    linux/arm64)
        ARCH="arm64"
        ;;

    *)
        bf-error "Unsupported target platform: ${TARGETPLATFORM}."
        ;;

esac

bf-echo "Platform architecture ${ARCH}."


#======================================================================================================================
# Get .NET Version.
#======================================================================================================================

cd /tmp

V=$(cat DOTNET_REVISION)
bf-echo ".NET version ${V}."


#======================================================================================================================
# Verify checksum of a dotnet download.
#   1   Either 'runtime' or 'aspnet'
#======================================================================================================================

verify () {

    DL="${ASPNET_VERSION}-${ARCH}-${1}"

    case "${DL}" in

        3.1-x64-runtime)    HASH="2f66b0d2c4cb7aa87298650afde34c78008de1abf59f5432aa68d21b97ed81b2189933fa690388f856c6bbf1f979afc97536867866cc878af25884d7f2a33575" ;;
        3.1-arm64-runtime)  HASH="c6699ddb9297340c2c9539fcc9eeb8b898397c26f2ca2f6162605bbbf54e3e8957148d93ef353f79ceb76c37ccfd8f7648383be64b6112de757312689de3cebf" ;;
        6-x64-runtime)      HASH="13faef12fe0bd89bff41bd284a461a2785c947a202a391879bf20521d1d705f5f19a293b5ca943d41f575d3f3a3f25c0234f4f282dac936b6e7b22e13b5cad1f" ;;
        6-arm64-runtime)    HASH="3b981fe729d623758b9430f6f52d6dca6598923f49b55a9f12a94e9eb67bb6d88a872aab7df511d9627c951829fe0606b97239e5f393195551e58889263e3a2b" ;;
        7-x64-runtime)      HASH="41640448d291d9373d2effd5e61cd8f24664891df7f46fb6eb4fdb16929ff774a12a3ee4de90cf4357ec230b07c56978abf2ceeeb954d74baa48bd3648177e0f" ;;
        7-arm64-runtime)    HASH="b9a7f44e93170a538963f5078c756993c414b5594bfc86965ee03fd83d681f4a65cbdf783309e5b66fec35fc982aa49c89137ed8d22897cf0aa8db9aaabdba08" ;;

        3.1-x64-aspnet)     HASH="d67edf1ed7817c002e1f444baf3a48b71d6f3328ed3f63287d744445665db846f63d24f4f8dd97f99d85f9d5f28fd0d1f1b8efa0c88ed7545a3ee9cfc491f7d0" ;;
        3.1-arm64-aspnet)   HASH="3d4baee2ca9e064c6f53ba1d89c099273a245c0fa3f6406485b2d6ed0e0526df2e28d0f69ede1c5855d8eb6b2401c1d862b0a622e2ec7cc8ec671266d9563f2f" ;;
        6-x64-aspnet)       HASH="081f1cddb00d8c86877d594ba09d38a2af51184bb253c33a57ed0893c828a44a1d68c2c244ed6f846f4732c2903aa576a3d3caa5c30ed03c6d2aa59f332e5ac2" ;;
        6-arm64-aspnet)     HASH="fdb4a5df648429977e4152de49e009bb16e812143288b2a76c5ab8e4f95002dd2b911b4a08fa7cd03df25cec2e81c7a365eb608ccc5803ee902c742ba5c0dc66" ;;
        7-x64-aspnet)       HASH="e92d25bec3a3b0be34d433e572dfc344c84541fd3455362bdf6621cc47a542b1d9eb85bdf58877a76aea58223c9073e7768d60ba11ae2e308e499d2994ff329b" ;;
        7-arm64-aspnet)     HASH="89e5b79e70ded7036c0db6ab8119e28ec2d0608e04fa99218defca2061fba0b927fc90af0c2dfb5ae384333f814d7d9f66e8218b3fb519b941cfd958461452b7" ;;

        *)                  bf-error "Unsupported dotnet download: ${DL}." ;;

    esac

    bf-echo "Verifying ${1} download..."
    echo "${HASH}  ${1}.tar.gz" | sha512sum -c -
    bf-done

}


#======================================================================================================================
# Download and install .NET Runtime.
#======================================================================================================================

DOTNET=/usr/share/dotnet

# if [ "$(echo ${V} | cut -c 1)" == "7" ] ; then
#     V="7.0.0-rc.2.22472.3"
#     bf-echo "Changing version to ${V}."
# fi

RUNTIME="runtime"
RUNTIME_URL="https://dotnetcli.azureedge.net/dotnet/Runtime/${V}/dotnet-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bf-echo "Downloading ${RUNTIME_URL}..."
wget -O ${RUNTIME}.tar.gz ${RUNTIME_URL}
bf-done

verify ${RUNTIME}

bf-echo "Installing .NET runtime..."
mkdir -p ${DOTNET} \
    && tar -C ${DOTNET} -oxzf ${RUNTIME}.tar.gz \
    && ln -s ${DOTNET}/dotnet /usr/bin/dotnet

[[ -d ${DOTNET} ]] && bf-done \
    || bf-error ".NET runtime not installed."


#======================================================================================================================
# Download and install ASP.NET Runtime.
#======================================================================================================================

# if [ "$(echo ${V} | cut -c 1)" == "7" ] ; then
#     V="7.0.0-rc.2.22476.2"
#     bf-echo "Changing version to ${V}."
# fi

ASPNET="aspnet"
ASPNET_URL="https://dotnetcli.azureedge.net/dotnet/aspnetcore/Runtime/${V}/aspnetcore-runtime-${V}-linux-musl-${ARCH}.tar.gz"
bf-echo "Downloading ${ASPNET_URL}..."
wget -O ${ASPNET}.tar.gz ${ASPNET_URL}
bf-done

verify ${ASPNET}

bf-echo "Installing ASP.NET..."
tar -ozxf ${ASPNET}.tar.gz -C ${DOTNET} ./shared/Microsoft.AspNetCore.App

[[ -d ${DOTNET}/shared/Microsoft.AspNetCore.App/${V} ]] && bf-done \
    || bf-error "ASP.NET runtime not installed."
